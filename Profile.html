<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="normalize.css">
        <link rel="stylesheet" href="style.css">
        <script src="CheckLogin.js"></script>

        <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>


        <style>
          
            #account-content{
                display: flex;
                flex-direction: column;
                width: 70%;
                margin: auto;
                gap: 20px;
            }
            #account {
                width:80px;
                height: 80px;
                background-color: #380909; /* Blue */
                color: white;
                font-size: 40px;
                font-weight: bold;
                display: flex;
                justify-content: center;
                align-items: center;
                border-radius: 50%;
                text-transform: uppercase;
                margin-left: 10%;
                margin-right: 18px;
            }
           

            #head{
                display: flex;
                flex-direction: row;
                align-items: center;
                border-radius: 10px;
                height: 200px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
               
                
            }
            #username{
                font-size: 30px;
                margin-right: 400px;
                
            }
            #account-info{
                height: 550px;
               
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                margin-bottom: 10%;
            }
            .info{
                display: flex;
                flex-direction: row;
                align-items: center;
                margin-top: 1.5%;
                margin-left: 10.5%;
                
            }
            .info input{
                font-size: 18px;
                border:none;
                background: transparent;
                width: 500px;
                border-radius: 10px;
                padding: 1%;
                
            }
            .attributes{
                margin-right: 15px;
               font-weight: bold;
               font-size: 19px;
            }
            #head button{
                font-size: 1.8rem;
                padding: 1.4%;
                border-radius: 10px;
                color: white;
                background-color:#940385 ;
                border: none;
                cursor: pointer;
                margin-right: 40px;
                
            }
            
            #editBtn:hover{
              transform: scale(1.1);
              transition: transform 0.3s ease;
            }
            #logoutBtn:hover{
                transform: scale(1.1);
                transition: transform 0.3s ease;
            }
            #saveBtn {
                background-color: #028922;
                border: none;
                color: rgb(255, 255, 255);
                font-size: 25px;
                margin-left: 10%;
                margin-top: 20px;
                padding: 1%;
                border-radius: 10px;
                cursor: pointer;
                display: none;

            }
            #saveBtn:hover{
              background-color: #00ba2c;
            }
            #cancelBtn{
                background-color: #b70025;
                border: none;
                color: rgb(255, 255, 255);
                font-size: 25px;
                margin-left: 5%;
                margin-top: 20px;
                padding: 1%;
                border-radius: 10px;
                cursor: pointer;
                display: none;
            }
            #cancelBtn:hover{
              background-color: #df0101;
            }
        </style>
    </head>
    <body>

        <header>
            <div id="logo">
              <a href="index.html" >
                <img src="Images/logo.jpeg" alt="">
              </a>
            </div>

            <section id="header-icons">
              <div id="header-category">
                  <a href="Home_tool.html" class="head-category">

                    <p >Home Tools</p>
                  </a>
                  <a href="cars.html" class="head-category">

                    <p>Cars</p>
                  </a>
                  <a href="home-services.html" class="head-category">

                    <p>Toys</p>
                  </a>
                  <a href="gadgets.html" class="head-category">

                    <p>Mobile Phones & Gadgets</p>
                  </a>
                  <a href="womens-fashion.html" class="head-category">
                    <p>Women's Fashion</p>
                  </a>
                  <a href="mens-fashion.html" class="head-category" >
                    <p>Men's Fashion</p>
                  </a>

                  <a href="luxury.html" class="head-category">
                    <p>Bicycles</p>
                  </a>

                  <a href="SignUp.html" class="register-button">
                    <p>Sign Up</p>
                  </a>

                  <a href="Login.html" class="register-button">
                    <p>Login</p>
                  </a>
                  <div id="accountContainer" style="display: none;">
                    <button id="accountBtn" class="account-button">
                      <div id="avatar"></div>
                      <span id="usernameDisplay"></span>
                    </button>
                  </div>
                  

              </div>
              <div id="second-row">
                <div id="search-box">
                  <i class='bx bx-search'></i>

                  <input type="text" id="input-box" placeholder="Search anything" autocomplete="off">

                </div>

                <div id="function-buttons" style="display: none;" >
                  <a href="wishlist.html" aria-label="Wishlist">
                      <i class='bx bx-heart'></i>
                  </a>
          
                  <a href="cart.html" aria-label="Cart">
                      <i class='bx bx-cart-alt'></i>
                  </a>

                  
                </div>
              </div>
            </section>

            


        </header>
        <main>
            <section id="account-content">

                
                
                <div id="head">
                    <div id="account"></div>
                    <div id="username"></div>
                    <button id="editBtn">Edit Profile</button>
                    <button id="logoutBtn">Logout</button>
                    
                </div>
                    
               
            
                <section id="account-info">
                  
          
                  <div class="info">
                      <p class="attributes">Password:</p>
                      <input type="text" id="passwordInput" class="input-field" disabled>
                  </div>
          
                  <div class="info">
                      <p class="attributes">Email:</p>
                      <input type="email" id="emailInput" class="input-field" disabled>
                  </div>
          
                  <div class="info">
                      <p class="attributes">Contact Number:</p>
                      <input type="text" id="contactNoInput" class="input-field" disabled>
                  </div>
          
                  <div class="info">
                      <p class="attributes">Address:</p>
                      <input type="text" id="addressInput" class="input-field" disabled>
                  </div>
          
                  <div class="buttons">
                      
                      <button id="saveBtn">Confirm Change</button>
                      <button id="cancelBtn">Cancel</button>
                      
                  </div>
              </section>
                
            </section>
            


           

            

        </main>
        
        <script>
           // Retrieve stored data
            const username = localStorage.getItem("Username") ;
            const userPassword = localStorage.getItem("userPassword") ;
            const userEmail = localStorage.getItem("userEmail");
            const userContactNo = localStorage.getItem("userContactNo"); 
            const userAddress = localStorage.getItem("userAddress");

            
            // Set default values in input fields
            document.getElementById("username").textContent = username;
            document.getElementById("account").textContent = username.charAt(0);
            document.getElementById("passwordInput").value = userPassword;
            document.getElementById("emailInput").value = userEmail;
            document.getElementById("contactNoInput").value = userContactNo !== 'undefined' ? userContactNo : "";
            document.getElementById("addressInput").value = userAddress !== 'undefined' ? userAddress : "";

            const editBtn = document.getElementById("editBtn");
            const saveBtn = document.getElementById("saveBtn");
            const cancelBtn = document.getElementById("cancelBtn");
            const inputs = document.querySelectorAll(".input-field");

            // Enable editing
            editBtn.addEventListener("click", () => {
                inputs.forEach(input => input.disabled = false);
                editBtn.style.display = "none";
                saveBtn.style.display = "inline-block";
                cancelBtn.style.display = "inline-block";
                inputs.forEach(input => {

                  inputs.forEach(input => {
                      input.style.border = "2px solid  #940385"; // Apply border to each input element
                  });

                })
            });

            // Save changes
           
            saveBtn.addEventListener("click", async () => {  // Add async here
              
              const username = localStorage.getItem("Username");
              const password = document.getElementById("passwordInput").value;
              const email = document.getElementById("emailInput").value;
              const contactNO = document.getElementById("contactNoInput").value;
              const address = document.getElementById("addressInput").value;
              
              
             
              

              const apiKey = "6796461ab7d46ae0e4052d24"; 
              const databaseUrl = "https://useraccounts-437f.restdb.io/rest/website-users"; 
              
              try {
                  const response = await fetch(databaseUrl, {
                      method: "GET",
                      headers: {
                          "Content-Type": "application/json",
                          "x-apikey": apiKey,
                          "cache-control": "no-cache",
                      }
                  });
                 
                  if (response.ok) {
                      const users = await response.json();
                      const user = users.find(user => user.username == username); // Ensure correct field name
                    
                      console.log(username)
                      if (user) 
                      {
                          // Update user data
                          const updatedUser = {
                            username: username,  // Ensure this is included
                            password: password,
                            email: email,
                            contactNO: contactNO,
                            address: address
                          };
                          
                          const updateResponse = await fetch(`${databaseUrl}/${user._id}`, {  // Update request
                              method: "PUT",  // Or use PATCH
                              headers: {
                                  "Content-Type": "application/json",
                                  "x-apikey": apiKey,
                                  "cache-control": "no-cache",
                              },
                              body: JSON.stringify(updatedUser)
                          });

                          if (updateResponse.ok) {

                              localStorage.setItem("userPassword", user.password);
                              localStorage.setItem("userEmail", user.email);
                              localStorage.setItem("userContactNo",user.contactNO);
                              localStorage.setItem("userAddress",user.address);

                              window.alert("Account information updated!");
                              
                          } 
                          else 
                          {
                              const errorText = await updateResponse.text();
                              console.error("Update failed:", updateResponse.status, updateResponse.statusText, errorText);
                              
                              window.alert("Failed to update account. Try again.");
                              window.location.href = "Profile.html"
                          }
                      } 
                      else{
                        console.log("User not found");
                        window.alert("User not found. Please check the username or register.");
                      }

                      
                  } 
                  else 
                  {
                    console.log("error")
                    window.alert("Failed to fetch user data!")
                   
                      
                  }
              } 
              catch (error) 
              {
                  console.error("Error:", error);
                  window.alert( "An error occurred. Please try again.")
                  
              }

              // Disable inputs and switch buttons back
              inputs.forEach(input => input.disabled = true);
              inputs.forEach(input => {
                input.style.border = 'none'
              })
              editBtn.style.display = "inline-block";
              saveBtn.style.display = "none";
              cancelBtn.style.display = 'none'
          });

          // Cancel button to reload the page
          cancelBtn.addEventListener("click", () => {
              location.reload();
          });

          // Logout function
          document.getElementById("logoutBtn").addEventListener("click", () => {
              localStorage.clear();
              window.location.href = "index.html";
          });

            
          </script>
    </body>
</html>